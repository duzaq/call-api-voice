# Configurações globais
debug=3
log_stderror=yes
log_facility=LOG_LOCAL0

# Módulos a serem carregados
loadmodule "sl.so"
loadmodule "tm.so"
loadmodule "rr.so"
loadmodule "maxfwd.so"
loadmodule "textops.so"
loadmodule "sipmsgops.so"
loadmodule "xlog.so"
loadmodule "sanity.so"
loadmodule "ctl.so"
loadmodule "mi_fifo.so"
loadmodule "acc.so"
loadmodule "dialog.so"
loadmodule "dispatcher.so"
loadmodule "rtpengine.so"

# Configuração do socket
listen=udp:0.0.0.0:5060

# Roteamento básico
route {
    # Verifica o número máximo de encaminhamentos
    if (!mf_process_maxfwd_header("10")) {
        sl_send_reply("483", "Too Many Hops");
        exit;
    }

    # Verifica a sanidade da mensagem SIP
    if (!sanity_check("1511", "7")) {
        sl_send_reply("400", "Bad Request");
        exit;
    }

    # Roteia a chamada para o endpoint do Flask
    if ($rU == "suporte" || $rU == "vendas") {
        $du = "sip:app:5060";  # Encaminha para o serviço Flask
        t_relay();
        exit;
    }

    # Responde para números desconhecidos
    sl_send_reply("404", "Not Found");
}
